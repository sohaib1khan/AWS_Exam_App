<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Developer Associate Study App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>AWS Developer Associate Study Quiz</h1>
            <nav>
                {% if session.username %}
                    <a href="{{ url_for('index') }}">Home</a>
                    <a href="{{ url_for('quiz') }}">Take Quiz</a>
                    <a href="{{ url_for('add_question') }}">Add Question</a>
                    <a href="{{ url_for('manage_questions') }}">Manage Questions</a>
                    <a href="{{ url_for('flashcards') }}">Flashcards</a>   <!-- ADD THIS LINE -->
                    <span style="color: #ff9900; margin-left: 15px;">Welcome, {{ session.username }}!</span>
                    <a href="{{ url_for('logout') }}" style="margin-left: 15px;">Logout</a>
                {% endif %}
            </nav>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
            üåô Dark
        </button>
    </header>
    
    <main>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="flash-messages">
              {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>
    
    <footer class="footer">
        <p>
            AWS Developer Associate Study App | 
            <a href="https://github.com/sohaib1khan/AWS_Exam_App.git" target="_blank" rel="noopener noreferrer" style="color: #ff9900; text-decoration: none;">
                View on GitHub ‚≠ê
            </a>
        </p>
    </footer>

    <script>
        // Theme Management
        const THEME_KEY = 'aws_quiz_theme';
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            setTheme(savedTheme);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const toggleButton = document.getElementById('theme-toggle');
            
            if (theme === 'dark') {
                toggleButton.textContent = '‚òÄÔ∏è Light';
            } else {
                toggleButton.textContent = 'üåô Dark';
            }
            
            localStorage.setItem(THEME_KEY, theme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Progress tracking functions (updated to work with server-side authentication)
        function resetProgress() {
            if (confirm('Are you sure you want to reset your progress? This cannot be undone.')) {
                // Note: With server-side auth, you might want to add a backend endpoint for this
                fetch('/reset_progress', { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            updateProgressUI();
                            if (window.location.pathname.includes('/quiz')) {
                                window.location.reload();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error resetting progress:', error);
                        // Fallback to page reload
                        window.location.reload();
                    });
            }
        }
        
        // Update progress UI for server-side auth
        function updateProgressUI() {
            // Update progress counter if it exists
            const counterElement = document.getElementById('progress-counter');
            if (counterElement) {
                counterElement.textContent = 'Loading progress...';
                
                fetch('/question_stats')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const total = data.total;
                        const completed = data.completed || 0;
                        counterElement.textContent = `${completed} / ${total} completed`;
                        
                        // Update progress bar if it exists
                        const progressBar = document.getElementById('progress-bar-fill');
                        if (progressBar && total > 0) {
                            const percentage = (completed / total) * 100;
                            progressBar.style.width = `${percentage}%`;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching question stats:', error);
                        counterElement.textContent = 'Error loading progress';
                    });
            }
            
            // Update question cards if they exist (server-side completion status)
            document.querySelectorAll('.question-card').forEach(card => {
                const questionId = card.dataset.questionId;
                
                // Check if this card has completion data from server
                if (card.dataset.completed === 'true') {
                    card.classList.add('completed');
                    const isCorrect = card.dataset.userCorrect === 'true';
                    const status = isCorrect ? 'correct' : 'incorrect';
                    card.classList.add(status);
                    
                    // Add completed indicator if it doesn't exist
                    if (!card.querySelector('.completion-status')) {
                        const statusIndicator = document.createElement('div');
                        statusIndicator.className = `completion-status ${status}`;
                        statusIndicator.textContent = isCorrect ? 'Answered Correctly' : 'Answered Incorrectly';
                        
                        const heading = card.querySelector('h3');
                        if (heading) {
                            heading.appendChild(statusIndicator);
                        }
                    }
                }
            });
        }

        // Markdown preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme first
            initializeTheme();
            
            const markdownEditors = document.querySelectorAll('.markdown-editor');
            
            markdownEditors.forEach(editor => {
                const previewContainer = editor.closest('.markdown-field')?.querySelector('.markdown-preview');
                if (!previewContainer) return;
                
                // Update preview on input
                editor.addEventListener('input', function() {
                    updateMarkdownPreview(editor, previewContainer);
                });
                
                // Initialize preview
                updateMarkdownPreview(editor, previewContainer);
            });
            
            function updateMarkdownPreview(editor, previewContainer) {
                const markdownText = editor.value;
                
                // Make AJAX request to get HTML preview
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '{{ url_for("markdown_preview") }}', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        previewContainer.innerHTML = xhr.responseText;
                    }
                };
                
                xhr.send('text=' + encodeURIComponent(markdownText));
            }
            
            // Initialize progress UI
            updateProgressUI();
        });
    </script>
</body>
</html>